<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!--Generated with Mod Manager (c) 2013 Yoshi2889-->
<modification xmlns:smf="http://www.simplemachines.org/" xmlns="http://www.simplemachines.org/xml/modification">
    <id>margarett:CustomActions</id>
    <version>0.1</version>
    <file name="$boarddir/index.php">
        <operation>
            <search position="before"><![CDATA[		'buddy' => array('Subs-Members.php', 'BuddyListToggle'),
]]></search>
            <add><![CDATA[		'ca_edit' => array('CustomAction.php' , 'CustomActionEdit'),
		'ca_list' => array('CustomAction.php' , 'CustomActionList'),
]]></add>
        </operation>
        <operation>
            <search position="before"><![CDATA[	call_integration_hook('integrate_actions', array(&$actionArray));

]]></search>
            <add><![CDATA[	// Add custom actions to the array.
	$custom_actions = explode(';', $modSettings['ca_cache']);
	foreach ($custom_actions as $custom_action)
		$actionArray[$custom_action] = array('CustomAction.php', 'ViewCustomAction');

]]></add>
        </operation>
    </file>
    <file name="$languagedir/Modifications.english.php">
        <operation>
            <search position="end" />
            <add><![CDATA[$txt['permissiongroup_custom_pages'] = 'Custom Pages';
$txt['permissiongroup_simple_custom_pages'] = 'Working with Custom Pages';
$txt['permissionname_create_custom_page'] = 'Can create Custom Pages';
$txt['permissionname_edit_custom_page'] = 'Can edit Custom Pages';
$txt['permissionname_simple_edit_custom_page_own'] = 'Can edit own Custom Pages';
$txt['permissionname_simple_edit_custom_page_any'] = 'Can edit any Custom Pages';
$txt['permissionname_edit_custom_page_own'] = 'Own Pages';
$txt['permissionname_edit_custom_page_any'] = 'Any Pages';
$txt['permissionname_remove_custom_page'] = 'Can remove Custom Pages';
$txt['permissionname_simple_remove_custom_page_own'] = 'Can remove own Custom Pages';
$txt['permissionname_simple_remove_custom_page_any'] = 'Can remove any Custom Pages';
$txt['permissionname_remove_custom_page_own'] = 'Own Pages';
$txt['permissionname_remove_custom_page_any'] = 'Any Pages';
$txt['custom_action_shorttitle'] = 'Custom Actions';
$txt['core_settings_item_ca'] = 'Custom Actions';
$txt['core_settings_item_ca_desc'] = 'With custom actions you can create custom pages wrapped in your forum\'s theme.';
$txt['custom_action_desc'] = 'From this page you can create and modify your own custom pages.';
$txt['custom_action_title'] = 'Custom Actions';
$txt['custom_action_title_sub'] = 'Sub-Actions For "%1$s"';
$txt['custom_action_none'] = 'You have not created any custom actions yet!';
$txt['custom_action_none_sub'] = 'You have not created any sub-actions for the "%1$s" action yet!';
$txt['custom_action_name'] = 'Action Name';
$txt['custom_action_type'] = 'Type';
$txt['custom_action_type_0'] = 'HTML';
$txt['custom_action_type_1'] = 'BBC';
$txt['custom_action_type_2'] = 'PHP';
$txt['custom_action_sub_actions'] = 'Sub-Actions';
$txt['custom_action_enabled'] = 'Enabled';
$txt['custom_action_my_actions'] = 'My Actions';
$txt['custom_action_make_new'] = 'New Action';
$txt['custom_action_make_new_sub'] = 'New Sub-Action';
$txt['custom_action_not_found'] = 'The requested action was not found.';
$txt['custom_action_invalid_url'] = 'Action URLs may only contain letters, numbers and underscores.';
$txt['custom_action_settings'] = 'Action Settings:';
$txt['custom_action_url_desc'] = 'This may only contain letters, numbers and underscores.';
$txt['custom_action_permissions_mode'] = 'Permissions Mode';
$txt['custom_action_permissions_mode_0'] = 'Visible To Everyone';
$txt['custom_action_permissions_mode_1'] = 'Visible To Selected Groups';
$txt['custom_action_permissions_mode_2'] = 'Same As Parent Action';
$txt['custom_action_body'] = 'Body';
$txt['custom_action_body_html'] = 'HTML Body';
$txt['custom_action_body_php'] = 'Template Code';
$txt['custom_action_delete_sure'] = 'Are you sure you want to delete this action?';
$txt['custom_action_header'] = 'HTML Headers';
$txt['custom_action_source'] = 'Source File Code';
$txt['custom_action_source_desc'] = 'This code will be evaluated before any templates are displayed. If you don\'t understand this you should just put all your code in the template code box. No output should be displayed here.';
$txt['custom_action_header_desc'] = 'This code will be displayed in the header section.';
$txt['custom_action_body_html_desc'] = 'This code will be displayed in the body section.';
$txt['custom_action_body_php_desc'] = 'You should display all output here.';
$txt['custom_action_body_desc'] = 'This is the body of your custom page.';
$txt['custom_action_url'] = 'Action URL';
$txt['custom_action_settings_code'] = 'Action Code:';
$txt['custom_action_menu'] = 'Show Menu Button';
$txt['custom_action_guest_not_allowed'] = 'Custom Actions Error - Guest access not allowed';
$txt['custom_action_view_not_allowed'] = 'Custom Actions Error - You are not allowed to view this action';
$txt['custom_action_create_not_allowed'] = 'Custom Actions Error - You are not allowed to create new actions';
$txt['custom_action_create_sub_not_allowed'] = 'Custom Actions Error - You are not allowed to create sub-actions of actions you don\'t own';
$txt['custom_action_edit_not_allowed'] = 'Custom Actions Error - You are not allowed to edit this action';
$txt['permissiongroup_custom_pages'] = 'Custom Pages';
$txt['permissiongroup_simple_custom_pages'] = 'Working with Custom Pages';
$txt['permissionname_create_custom_page'] = 'Can create Custom Pages';
$txt['permissionname_edit_custom_page'] = 'Can edit Custom Pages';
$txt['permissionname_simple_edit_custom_page_own'] = 'Can edit own Custom Pages';
$txt['permissionname_simple_edit_custom_page_any'] = 'Can edit any Custom Pages';
$txt['permissionname_edit_custom_page_own'] = 'Own Pages';
$txt['permissionname_edit_custom_page_any'] = 'Any Pages';
$txt['permissionname_remove_custom_page'] = 'Can remove Custom Pages';
$txt['permissionname_simple_remove_custom_page_own'] = 'Can remove own Custom Pages';
$txt['permissionname_simple_remove_custom_page_any'] = 'Can remove any Custom Pages';
$txt['permissionname_remove_custom_page_own'] = 'Own Pages';
$txt['permissionname_remove_custom_page_any'] = 'Any Pages';
]]></add>
        </operation>
    </file>
    <file name="$sourcedir/ManagePermissions.php">
        <operation>
            <search position="before"><![CDATA[			'profile_remote_avatar' => array(false, 'profile', 'use_avatar'),
]]></search>
            <add><![CDATA[			'create_custom_page' => array(false, 'custom_pages', 'custom_pages'),
			'edit_custom_page' => array(true, 'custom_pages', 'custom_pages', 'custom_pages'),
			'remove_custom_page' => array(true, 'custom_pages', 'custom_pages', 'custom_pages'),
]]></add>
        </operation>
    </file>
    <file name="$sourcedir/Subs.php">
        <operation>
            <search position="before"><![CDATA[		call_integration_hook('integrate_menu_buttons', array(&$buttons));

]]></search>
            <add><![CDATA[		// Any custom action buttons?
		$ca_buttons = unserialize($modSettings['ca_menu_cache']);
		//Show a main menu button with all actions listed inside
		$has_actions = false;
		$own_actions = false;
		foreach ($ca_buttons as $button) {
			//Run through all actions. If we are allowed to see them, then we should see them
			if (!empty($button[2]) ? allowedTo($button[2]) : true)
				$has_actions = true;
			//Is any of the actions ours?
			if (!empty($context['user']['id']) && ($context['user']['id'] == $button[3]))
				$own_actions = true;
			//If we evalueate both conditions we don't need to run this anymore!
			if ($has_actions && $own_actions)
				break;
		}
		$ca_sub_buttons = array(); //array for sub-buttons
		//Do we have any actions of our own? Then we can just list them
		if ($own_actions) {
			$ca_sub_buttons[] = array(
				'title' => $txt['custom_action_my_actions'],
				'href' => $scripturl . '?action=ca_list',
				'show' => true, //No need to check here
			);
		}
		//Are we allowed to create actions? Then we can also link that
		if (allowedTo('create_custom_page')) {
			$ca_sub_buttons[] = array(
				'title' => $txt['custom_action_make_new'],
				'href' => $scripturl . '?action=ca_edit',
				'show' => true, //No need to check here
			);
		}
		if ($has_actions) {
			foreach ($ca_buttons as $button) {
				if (!empty($button[4]))
					$ca_sub_buttons[] = array(
						'title' => $button[1],
						'href' => $scripturl . '?action=' . $button[0],
						'show' => $button[2] ? allowedTo($button[2]) : true,
					);
			}	
		}
		
		//Is there anything to create a button?
		if (!empty($ca_sub_buttons)) {
			//Custom Actions menu button
			$buttons['ca_actions'] = array(
				'title' => $txt['custom_action_shorttitle'],
				'href' => $ca_sub_buttons[0]['href'], //We need a link, so be it the first action in the menu...
				'show' => true,
				'sub_buttons' => $ca_sub_buttons,
				'is_last' => !$context['right_to_left'],
			);		
		}

]]></add>
        </operation>
    </file>
</modification>